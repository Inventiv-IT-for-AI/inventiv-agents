name: GHCR (arm64 build + promote)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      promote_env:
        description: "Promote a version tag to this env tag (staging/prod)"
        required: false
        type: choice
        options:
          - staging
          - prod
      source_tag:
        description: "Existing immutable tag to promote (e.g. v0.2.2 or b25bd1790939)"
        required: false
        type: string

permissions:
  contents: read
  packages: write

env:
  # IMPORTANT: GHCR repository names must be lowercase
  IMAGE_REPO_PATH: inventiv-agents

jobs:
  build_arm64:
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compute image repo (lowercase)
        run: |
          echo "OWNER_LC=$(echo \"$GITHUB_REPOSITORY_OWNER\" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"
          echo "TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"
          echo "SHA=${GITHUB_SHA:0:12}" >> "$GITHUB_ENV"

      - uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push (linux/arm64)
        run: |
          set -euo pipefail
          REPO="ghcr.io/${OWNER_LC}/${IMAGE_REPO_PATH}"

          docker buildx build --platform linux/arm64 \
            -f Dockerfile.rust.prod --build-arg SERVICE_NAME=inventiv-api \
            -t "${REPO}/inventiv-api:${TAG}" \
            -t "${REPO}/inventiv-api:${SHA}" \
            --push .

          docker buildx build --platform linux/arm64 \
            -f Dockerfile.rust.prod --build-arg SERVICE_NAME=inventiv-orchestrator \
            -t "${REPO}/inventiv-orchestrator:${TAG}" \
            -t "${REPO}/inventiv-orchestrator:${SHA}" \
            --push .

          docker buildx build --platform linux/arm64 \
            -f Dockerfile.rust.prod --build-arg SERVICE_NAME=inventiv-finops \
            -t "${REPO}/inventiv-finops:${TAG}" \
            -t "${REPO}/inventiv-finops:${SHA}" \
            --push .

          docker buildx build --platform linux/arm64 \
            -f inventiv-frontend/Dockerfile \
            -t "${REPO}/inventiv-frontend:${TAG}" \
            -t "${REPO}/inventiv-frontend:${SHA}" \
            --push inventiv-frontend

  promote:
    if: github.event_name == 'workflow_dispatch' && inputs.promote_env != '' && inputs.source_tag != ''
    runs-on: ubuntu-latest
    steps:
      - name: Compute image repo (lowercase)
        run: |
          echo "OWNER_LC=$(echo \"$GITHUB_REPOSITORY_OWNER\" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_ENV"
          echo "PROMOTE_ENV=${{ inputs.promote_env }}" >> "$GITHUB_ENV"
          echo "SOURCE_TAG=${{ inputs.source_tag }}" >> "$GITHUB_ENV"

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote tags (same digest)
        run: |
          set -euo pipefail
          REPO="ghcr.io/${OWNER_LC}/${IMAGE_REPO_PATH}"

          docker buildx imagetools create -t "${REPO}/inventiv-api:${PROMOTE_ENV}" "${REPO}/inventiv-api:${SOURCE_TAG}"
          docker buildx imagetools create -t "${REPO}/inventiv-orchestrator:${PROMOTE_ENV}" "${REPO}/inventiv-orchestrator:${SOURCE_TAG}"
          docker buildx imagetools create -t "${REPO}/inventiv-finops:${PROMOTE_ENV}" "${REPO}/inventiv-finops:${SOURCE_TAG}"
          docker buildx imagetools create -t "${REPO}/inventiv-frontend:${PROMOTE_ENV}" "${REPO}/inventiv-frontend:${SOURCE_TAG}"
