name: Deploy (production)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Source tag to promote to :prod (sha12 or vX.Y.Z)"
        required: true

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  deploy:
    name: Promote + Deploy to production (manual)
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Promote -> :prod (same digest)
        env:
          IMAGE_REPO: ${{ secrets.IMAGE_REPO || format('ghcr.io/{0}/inventiv-agents', github.repository_owner) }}
        run: make images-promote-prod IMAGE_TAG=${{ inputs.image_tag }}

      - name: Write prod env file (for remote deploy)
        run: |
          set -euo pipefail
          mkdir -p env
          cat > env/prod.env <<'EOF'
          # Generated by GitHub Actions (deploy-prod)
          REMOTE_HOST=${{ secrets.PROD_REMOTE_HOST }}
          REMOTE_PORT=${{ secrets.PROD_REMOTE_PORT || 22 }}
          REMOTE_USER=${{ secrets.PROD_REMOTE_USER || 'ubuntu' }}
          SECRETS_DIR=${{ secrets.PROD_SECRETS_DIR }}

          # Image selection on the VM (deploy/docker-compose.nginx.yml)
          IMAGE_REPO=${{ secrets.IMAGE_REPO || format('ghcr.io/{0}/inventiv-agents', github.repository_owner) }}
          IMAGE_TAG=prod
          REGISTRY_USERNAME=${{ secrets.GHCR_USERNAME || github.repository_owner }}

          # Runtime
          RUST_LOG=${{ secrets.PROD_RUST_LOG || 'info' }}
          PROVIDER=${{ secrets.PROD_PROVIDER || '' }}
          SCALEWAY_PROJECT_ID=${{ secrets.PROD_SCALEWAY_PROJECT_ID || '' }}
          WORKER_AUTH_TOKEN=${{ secrets.PROD_WORKER_AUTH_TOKEN }}

          # DB
          POSTGRES_USER=${{ secrets.PROD_POSTGRES_USER || 'postgres' }}
          POSTGRES_PASSWORD=${{ secrets.PROD_POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.PROD_POSTGRES_DB || 'llminfra' }}

          # Edge / TLS / domains
          ROOT_DOMAIN=${{ secrets.PROD_ROOT_DOMAIN }}
          FRONTEND_DOMAIN=${{ secrets.PROD_FRONTEND_DOMAIN }}
          API_DOMAIN=${{ secrets.PROD_API_DOMAIN }}
          ACME_EMAIL=${{ secrets.PROD_ACME_EMAIL }}
          EOF

      - name: Setup SSH key
        run: |
          set -euo pipefail
          install -d -m 700 ~/.ssh
          echo "${{ secrets.PROD_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy update on production
        env:
          PRD_ENV_FILE: env/prod.env
          SSH_IDENTITY_FILE: ~/.ssh/deploy_key
        run: make prod-update


