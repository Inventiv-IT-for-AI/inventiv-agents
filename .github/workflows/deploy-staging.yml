name: Deploy (staging)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: deploy-staging
  cancel-in-progress: false

jobs:
  ci:
    name: CI gate
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Build (arm64) + Promote + Deploy to staging
    runs-on: ubuntu-latest
    needs: [ci]
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup QEMU (arm64)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tag
        id: meta
        run: |
          set -euo pipefail
          echo "sha12=${GITHUB_SHA:0:12}" >> "$GITHUB_OUTPUT"
          echo "owner_lc=$(echo \"$GITHUB_REPOSITORY_OWNER\" | tr '[:upper:]' '[:lower:]')" >> "$GITHUB_OUTPUT"

      - name: Build & push images (linux/arm64, sha)
        env:
          IMAGE_REPO: ${{ secrets.IMAGE_REPO || format('ghcr.io/{0}/inventiv-agents', steps.meta.outputs.owner_lc) }}
          IMAGE_TAG: ${{ steps.meta.outputs.sha12 }}
        run: |
          set -euo pipefail
          REPO="${IMAGE_REPO}"

          docker buildx build --platform linux/arm64 \
            -f Dockerfile.rust.prod --build-arg SERVICE_NAME=inventiv-api \
            -t "${REPO}/inventiv-api:${IMAGE_TAG}" \
            --push .

          docker buildx build --platform linux/arm64 \
            -f Dockerfile.rust.prod --build-arg SERVICE_NAME=inventiv-orchestrator \
            -t "${REPO}/inventiv-orchestrator:${IMAGE_TAG}" \
            --push .

          docker buildx build --platform linux/arm64 \
            -f Dockerfile.rust.prod --build-arg SERVICE_NAME=inventiv-finops \
            -t "${REPO}/inventiv-finops:${IMAGE_TAG}" \
            --push .

          docker buildx build --platform linux/arm64 \
            -f inventiv-frontend/Dockerfile \
            -t "${REPO}/inventiv-frontend:${IMAGE_TAG}" \
            --push inventiv-frontend

      - name: Promote sha -> :staging (same digest)
        env:
          IMAGE_REPO: ${{ secrets.IMAGE_REPO || format('ghcr.io/{0}/inventiv-agents', steps.meta.outputs.owner_lc) }}
        run: make images-promote-stg IMAGE_TAG=${{ steps.meta.outputs.sha12 }}

      - name: Write staging env file (for remote deploy)
        run: |
          set -euo pipefail
          mkdir -p env
          cat > env/staging.env <<'EOF'
          # Generated by GitHub Actions (deploy-staging)
          REMOTE_HOST=${{ secrets.STG_REMOTE_HOST }}
          REMOTE_PORT=${{ secrets.STG_REMOTE_PORT || 22 }}
          REMOTE_USER=${{ secrets.STG_REMOTE_USER || 'ubuntu' }}
          SECRETS_DIR=${{ secrets.STG_SECRETS_DIR }}

          # Image selection on the VM (deploy/docker-compose.nginx.yml)
          IMAGE_REPO=${{ secrets.IMAGE_REPO || format('ghcr.io/{0}/inventiv-agents', github.repository_owner) }}
          IMAGE_TAG=staging
          REGISTRY_USERNAME=${{ secrets.GHCR_USERNAME || github.repository_owner }}

          # Runtime
          RUST_LOG=${{ secrets.STG_RUST_LOG || 'info' }}
          PROVIDER=${{ secrets.STG_PROVIDER || '' }}
          SCALEWAY_PROJECT_ID=${{ secrets.STG_SCALEWAY_PROJECT_ID || '' }}
          WORKER_AUTH_TOKEN=${{ secrets.STG_WORKER_AUTH_TOKEN }}

          # DB
          POSTGRES_USER=${{ secrets.STG_POSTGRES_USER || 'postgres' }}
          POSTGRES_PASSWORD=${{ secrets.STG_POSTGRES_PASSWORD }}
          POSTGRES_DB=${{ secrets.STG_POSTGRES_DB || 'llminfra' }}

          # Edge / TLS / domains
          ROOT_DOMAIN=${{ secrets.STG_ROOT_DOMAIN }}
          FRONTEND_DOMAIN=${{ secrets.STG_FRONTEND_DOMAIN }}
          API_DOMAIN=${{ secrets.STG_API_DOMAIN }}
          ACME_EMAIL=${{ secrets.STG_ACME_EMAIL }}
          EOF

      - name: Setup SSH key
        run: |
          set -euo pipefail
          install -d -m 700 ~/.ssh
          echo "${{ secrets.STG_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

      - name: Deploy update on staging
        env:
          STG_ENV_FILE: env/staging.env
          SSH_IDENTITY_FILE: ~/.ssh/deploy_key
        run: make stg-update


