version: '3.8'

services:
  # --- INFRA ---
  redis:
    image: redis:alpine
    volumes:
      - redis_data:/data

  db:
    image: timescale/timescaledb:latest-pg14
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=llminfra
    volumes:
      - db_data:/var/lib/postgresql/data

  # --- LOCAL WORKER TEST (NO GPU) ---
  # Lightweight fake vLLM that serves GET /v1/models for readiness checks.
  mock-vllm:
    image: python:3.11-slim
    profiles: ["worker-local"]
    command: ["python", "-u", "/app/mock_vllm.py"]
    environment:
      - MODEL_ID=demo-model
      - PORT=8000
    volumes:
      - ./inventiv-worker/mock_vllm.py:/app/mock_vllm.py:ro
    ports:
      - "${MOCK_VLLM_HOST_PORT:-18000}:8000"

  # Agent-only worker (no vLLM) for local testing.
  worker-agent:
    build:
      context: ./inventiv-worker
      dockerfile: Dockerfile.agent
    profiles: ["worker-local"]
    environment:
      - CONTROL_PLANE_URL=http://api:8003
      # Leave empty to exercise bootstrap-per-worker flow.
      - WORKER_AUTH_TOKEN=${WORKER_AUTH_TOKEN:-}
      - INSTANCE_ID=${INSTANCE_ID:-}
      - MODEL_ID=demo-model
      - VLLM_BASE_URL=http://mock-vllm:8000
      - WORKER_HEALTH_PORT=8080
      - WORKER_HEARTBEAT_INTERVAL_S=5
      - PYTHONUNBUFFERED=1
      # INSTANCE_ID must be provided at runtime (docker compose run -e INSTANCE_ID=...)
    ports:
      - "${WORKER_AGENT_HOST_PORT:-18080}:8080"
    depends_on:
      - mock-vllm
      - orchestrator

  # --- UI (exposed on host) ---
  # Run Next.js dev server inside Docker so the browser only talks to the UI port.
  # All backend calls go through same-origin proxy routes `/api/backend/*` implemented in Next route handlers.
  frontend:
    image: node:20-alpine
    profiles: ["ui"]
    working_dir: /app
    command: ["sh", "-lc", "npm install && npm run dev -- --hostname 0.0.0.0 --port 3000"]
    environment:
      # Frontend server-side proxy target (docker network)
      - API_INTERNAL_URL=http://api:8003
      # Improve file watching reliability on macOS/docker bind mounts
      - CHOKIDAR_USEPOLLING=1
      - WATCHPACK_POLLING=true
      - NODE_ENV=development
    volumes:
      - ./inventiv-frontend:/app
    ports:
      - "${UI_HOST_PORT:-3000}:3000"
    depends_on:
      - api

  # --- SERVICES (RUST) ---
  orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.rust
      args:
        SERVICE_NAME: inventiv-orchestrator
    command: cargo watch -w inventiv-orchestrator -w inventiv-common -w sqlx-migrations -x "run --release -p inventiv-orchestrator"
    volumes:
      - .:/app # Source code mount for hot reload
    environment:
      - DATABASE_URL=postgresql://postgres:password@db:5432/llminfra
      - REDIS_URL=redis://redis:6379
      - CARGO_TARGET_DIR=/app/target/inventiv-orchestrator
      - PROVIDER=${PROVIDER:-scaleway}
      - SCALEWAY_PROJECT_ID=${SCALEWAY_PROJECT_ID:-}
      - SCALEWAY_ACCESS_KEY=${SCALEWAY_ACCESS_KEY:-}
      - SCALEWAY_SECRET_KEY=${SCALEWAY_SECRET_KEY:-}
      - SCALEWAY_SSH_PUBLIC_KEY_FILE=/app/.ssh/llm-studio-key.pub
      - WORKER_AUTH_TOKEN=${WORKER_AUTH_TOKEN:-dev-worker-token}
      - WORKER_HEALTH_PORT=${WORKER_HEALTH_PORT:-8080}
      - WORKER_AUTO_INSTALL=${WORKER_AUTO_INSTALL:-0}
      - WORKER_CONTROL_PLANE_URL=${WORKER_CONTROL_PLANE_URL:-}
      - WORKER_AUTO_INSTALL_INSTANCE_PATTERNS=${WORKER_AUTO_INSTALL_INSTANCE_PATTERNS:-}
      - WORKER_MODEL_ID=${WORKER_MODEL_ID:-}
      - WORKER_VLLM_IMAGE=${WORKER_VLLM_IMAGE:-}
      - WORKER_AGENT_SOURCE_URL=${WORKER_AGENT_SOURCE_URL:-}
      - WORKER_EXPOSE_PORTS=${WORKER_EXPOSE_PORTS:-1}
      - WORKER_SSH_PRIVATE_KEY_FILE=${WORKER_SSH_PRIVATE_KEY_FILE:-/app/.ssh/llm-studio-key}
      - WORKER_SSH_USER=${WORKER_SSH_USER:-root}
      - RUST_LOG=debug
    depends_on:
      - db
      - redis

  api:
    build:
      context: .
      dockerfile: Dockerfile.rust
      args:
        SERVICE_NAME: inventiv-api
    command: cargo watch -w inventiv-api -w inventiv-common -w sqlx-migrations -x "run --release -p inventiv-api"
    volumes:
      - .:/app # Source code mount for hot reload
      # Default admin password file (dev/local)
      - ${SECRETS_DIR:-./deploy/secrets}:/run/secrets:ro
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@db:5432/llminfra
      - CARGO_TARGET_DIR=/app/target/inventiv-api
      - AUTO_SEED_CATALOG=1
      - SEED_CATALOG_PATH=/app/seeds/catalog_seeds.sql
      - BOOTSTRAP_DEFAULT_ADMIN=${BOOTSTRAP_DEFAULT_ADMIN:-1}
      - DEFAULT_ADMIN_USERNAME=${DEFAULT_ADMIN_USERNAME:-admin}
      - DEFAULT_ADMIN_EMAIL=${DEFAULT_ADMIN_EMAIL:-admin@inventiv.local}
      - DEFAULT_ADMIN_PASSWORD_FILE=${DEFAULT_ADMIN_PASSWORD_FILE:-/run/secrets/default_admin_password}
      # Dev convenience: allow a global worker token for heartbeat auth.
      - WORKER_AUTH_TOKEN=${WORKER_AUTH_TOKEN:-dev-worker-token}
      - WORKER_AUTO_INSTALL=${WORKER_AUTO_INSTALL:-0}
      - WORKER_AUTO_INSTALL_INSTANCE_PATTERNS=${WORKER_AUTO_INSTALL_INSTANCE_PATTERNS:-}
      - RUST_LOG=debug
    depends_on:
      - redis
      - db

  finops:
    build:
      context: .
      dockerfile: Dockerfile.rust
      args:
        SERVICE_NAME: inventiv-finops
    command: cargo watch -w inventiv-finops -w inventiv-common -w sqlx-migrations -x "run --release -p inventiv-finops"
    volumes:
      - .:/app # Source code mount for hot reload
    environment:
      - REDIS_URL=redis://redis:6379
      - DATABASE_URL=postgresql://postgres:password@db:5432/llminfra
      - CARGO_TARGET_DIR=/app/target/inventiv-finops
      - RUST_LOG=debug
    depends_on:
      - redis
      - db

volumes:
  redis_data:
  db_data:
