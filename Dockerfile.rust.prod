FROM rust:1.88-bookworm AS builder
WORKDIR /app

# Copy workspace manifests first (better build cache)
COPY Cargo.toml Cargo.lock ./
COPY inventiv-api/Cargo.toml ./inventiv-api/Cargo.toml
COPY inventiv-common/Cargo.toml ./inventiv-common/Cargo.toml
COPY inventiv-orchestrator/Cargo.toml ./inventiv-orchestrator/Cargo.toml
COPY inventiv-finops/Cargo.toml ./inventiv-finops/Cargo.toml

# Build dependencies (dummy sources for cache)
RUN mkdir -p inventiv-api/src inventiv-common/src inventiv-orchestrator/src inventiv-finops/src && \
    echo "fn main() {}" > inventiv-api/src/main.rs && \
    echo "fn main() {}" > inventiv-orchestrator/src/main.rs && \
    echo "fn main() {}" > inventiv-finops/src/main.rs && \
    echo "" > inventiv-common/src/lib.rs && \
    cargo build --release && \
    rm -rf inventiv-*/src

# Copy full source and build the selected binary
COPY . .

ARG SERVICE_NAME
#
# Provider features are compile-time in Rust. For production images we must enable the right ones.
# By default we ship orchestrator with Scaleway support (and optional mock for debug).
ARG ORCHESTRATOR_FEATURES=provider-scaleway,provider-mock
RUN FEAT=""; \
    if [ "${SERVICE_NAME}" = "inventiv-orchestrator" ]; then \
      FEAT="--features ${ORCHESTRATOR_FEATURES}"; \
    fi; \
    cargo build --release -p "${SERVICE_NAME}" ${FEAT} && \
    strip "target/release/${SERVICE_NAME}" || true

FROM debian:bookworm-slim AS runtime
RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates curl && \
    # Install Scaleway CLI (required for Block Storage volume attachment)
    # Scaleway CLI handles synchronization between Block Storage API and Instance API
    ARCH=$(dpkg --print-architecture) && \
    SCW_ARCH=$(if [ "$ARCH" = "amd64" ]; then echo "amd64"; elif [ "$ARCH" = "arm64" ]; then echo "arm64"; else echo "amd64"; fi) && \
    SCW_VERSION="2.49.0" && \
    curl -fsSL "https://github.com/scaleway/scaleway-cli/releases/download/v${SCW_VERSION}/scaleway-cli_${SCW_VERSION}_linux_${SCW_ARCH}" -o /usr/local/bin/scw && \
    chmod +x /usr/local/bin/scw && \
    rm -rf /var/lib/apt/lists/*
WORKDIR /app

ARG SERVICE_NAME
ENV SERVICE_NAME="${SERVICE_NAME}"
ENV RUST_LOG=info

COPY --from=builder "/app/target/release/${SERVICE_NAME}" "/usr/local/bin/${SERVICE_NAME}"

EXPOSE 8001 8003 8005
ENTRYPOINT ["sh", "-c", "/usr/local/bin/$SERVICE_NAME"]
