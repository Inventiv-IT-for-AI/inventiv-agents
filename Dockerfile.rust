FROM rust:latest
WORKDIR /app

# Needed by orchestrator for SSH bootstrap fallback installs.
RUN apt-get update && apt-get install -y openssh-client && rm -rf /var/lib/apt/lists/*

# Install cargo-watch for hot reload
RUN cargo install cargo-watch

# Copy only dependency files first (for caching)
COPY Cargo.toml Cargo.lock ./
COPY inventiv-api/Cargo.toml ./inventiv-api/
COPY inventiv-common/Cargo.toml ./inventiv-common/
COPY inventiv-orchestrator/Cargo.toml ./inventiv-orchestrator/
COPY inventiv-finops/Cargo.toml ./inventiv-finops/

# Create dummy source files and build dependencies (caching layer)
RUN mkdir -p inventiv-api/src inventiv-common/src inventiv-orchestrator/src inventiv-finops/src && \
    echo "fn main() {}" > inventiv-api/src/main.rs && \
    echo "fn main() {}" > inventiv-orchestrator/src/main.rs && \
    echo "fn main() {}" > inventiv-finops/src/main.rs && \
    echo "" > inventiv-common/src/lib.rs && \
    cargo build --release && \
    rm -rf inventiv-*/src

# Copy actual source (will be mounted via volume in dev)
COPY . .

# Service name passed as build arg
ARG SERVICE_NAME
ENV SERVICE_NAME=${SERVICE_NAME}

# Hot reload with cargo-watch
CMD cargo watch -x "run --release -p ${SERVICE_NAME}"
